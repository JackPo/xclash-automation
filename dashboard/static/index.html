<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xclash Mastermind</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#0a0a0f', 800: '#12121a', 700: '#1a1a24', 600: '#24242f' }
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        body { background: linear-gradient(135deg, #0a0a0f 0%, #12121a 100%); }
        .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(10px); }
        .glow { box-shadow: 0 0 20px rgba(59, 130, 246, 0.15); }
        .glow-yellow { box-shadow: 0 0 20px rgba(234, 179, 8, 0.15); }
        .card { background: linear-gradient(145deg, rgba(26,26,36,0.8) 0%, rgba(18,18,26,0.9) 100%); }
        .stat-value { font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace; }
        .flow-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .flow-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .pulse-slow { animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .progress-bar { background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%); }
        select { cursor: pointer; }
        select:focus { outline: none; box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.5); }
    </style>
</head>
<body class="text-gray-100 min-h-screen" x-data="dashboard()" x-init="init()">

    <!-- Header -->
    <header class="border-b border-gray-800/50 sticky top-0 z-50 glass">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <!-- Logo & Status -->
                <div class="flex items-center gap-8">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-xl">
                            <span>X</span>
                        </div>
                        <div>
                            <h1 class="text-lg font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">Mastermind</h1>
                            <div class="text-xs text-gray-500">xclash automation</div>
                        </div>
                    </div>

                    <!-- Status Pills -->
                    <div class="flex items-center gap-3">
                        <div class="flex items-center gap-2 px-3 py-1.5 rounded-full glass border border-gray-700/50">
                            <div class="w-2 h-2 rounded-full" :class="status.paused ? 'bg-yellow-400' : 'bg-green-400'"></div>
                            <span class="text-sm" x-text="status.paused ? 'Paused' : 'Running'"></span>
                        </div>
                        <div class="flex items-center gap-2 px-3 py-1.5 rounded-full glass border border-gray-700/50">
                            <span class="text-sm text-gray-400">View:</span>
                            <span class="text-sm font-medium"
                                  :class="{'text-purple-400': status.view === 'TOWN', 'text-blue-400': status.view === 'WORLD', 'text-gray-400': !status.view}"
                                  x-text="status.view || '...'"></span>
                        </div>
                    </div>
                </div>

                <!-- Live Stats -->
                <div class="flex items-center gap-6">
                    <div class="text-center">
                        <div class="text-2xl font-bold stat-value text-yellow-400" x-text="status.stamina ?? '--'"></div>
                        <div class="text-xs text-gray-500 uppercase tracking-wide">Stamina</div>
                    </div>
                    <div class="w-px h-8 bg-gray-700"></div>
                    <div class="text-center">
                        <div class="text-2xl font-bold stat-value text-blue-400" x-text="formatSeconds(status.idle_seconds)"></div>
                        <div class="text-xs text-gray-500 uppercase tracking-wide">Idle</div>
                    </div>
                    <div class="w-px h-8 bg-gray-700"></div>
                    <div class="text-center">
                        <div class="text-sm text-gray-400" x-text="lastUpdate"></div>
                        <div class="text-xs text-gray-500 uppercase tracking-wide">Updated</div>
                    </div>
                </div>
            </div>

            <!-- Active Flow Banner -->
            <div x-show="status.active_flows.length > 0" x-cloak
                 class="mt-3 px-4 py-2 rounded-lg bg-blue-500/20 border border-blue-500/30 flex items-center gap-3">
                <div class="w-2 h-2 rounded-full bg-blue-400 pulse-slow"></div>
                <span class="text-sm text-blue-300">Running: <span class="font-medium" x-text="status.active_flows.join(', ')"></span></span>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-8 space-y-8">

        <!-- Arms Race Card -->
        <section class="card rounded-2xl p-6 border border-gray-800/50 glow-yellow">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-8 h-8 rounded-lg bg-yellow-500/20 flex items-center justify-center text-yellow-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                    </svg>
                </div>
                <h2 class="text-lg font-semibold text-yellow-400">Arms Race</h2>
                <div class="ml-auto px-3 py-1 rounded-full bg-yellow-500/10 border border-yellow-500/20">
                    <span class="text-sm text-yellow-300">Day <span x-text="armsRace.day" class="font-bold"></span>/7</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Current Event -->
                <div class="bg-dark-800/50 rounded-xl p-5 border border-green-500/20">
                    <div class="text-xs text-gray-500 uppercase tracking-wide mb-2">Current Event</div>
                    <div class="text-xl font-bold text-green-400 mb-3" x-text="armsRace.current_event"></div>
                    <div class="flex items-center gap-2 mb-3">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="stat-value text-lg text-yellow-300" x-text="formatCountdown(armsRace.time_remaining_seconds)"></span>
                    </div>
                    <!-- Score Check -->
                    <div class="pt-3 border-t border-gray-700/50">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-gray-500 uppercase tracking-wide">Progress</span>
                            <button @click="checkArmsRaceScore()"
                                    :disabled="armsRaceScoreLoading"
                                    class="px-3 py-1 text-xs rounded-lg bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/30 disabled:opacity-50 transition-colors">
                                <span x-show="!armsRaceScoreLoading">Check Score</span>
                                <span x-show="armsRaceScoreLoading">Checking...</span>
                            </button>
                        </div>
                        <div x-show="armsRaceScore.current_points === null && !armsRaceScoreLoading && !armsRaceScore.error"
                             class="text-xs text-gray-500 italic">
                            No score checked yet for this event
                        </div>
                        <div x-show="armsRaceScore.current_points !== null" class="text-sm">
                            <div class="flex justify-between text-gray-300">
                                <span>Points:</span>
                                <span class="font-bold text-green-400" x-text="armsRaceScore.current_points?.toLocaleString()"></span>
                            </div>
                            <div x-show="armsRaceScore.chest3_target" class="flex justify-between text-gray-400">
                                <span>Chest 3:</span>
                                <span x-text="armsRaceScore.chest3_target?.toLocaleString()"></span>
                            </div>
                            <div x-show="armsRaceScore.points_to_chest3 !== null" class="flex justify-between text-gray-400">
                                <span>Remaining:</span>
                                <span :class="armsRaceScore.points_to_chest3 <= 0 ? 'text-green-400' : ''"
                                      x-text="armsRaceScore.points_to_chest3 <= 0 ? 'Complete!' : armsRaceScore.points_to_chest3?.toLocaleString()"></span>
                            </div>
                            <div x-show="armsRaceScore.last_checked" class="text-xs text-gray-500 mt-2 pt-2 border-t border-gray-700/50">
                                Checked <span x-text="formatTimeAgo(armsRaceScore.last_checked)"></span>
                            </div>
                        </div>
                        <div x-show="armsRaceScore.error" class="text-xs text-red-400" x-text="armsRaceScore.error"></div>
                    </div>
                </div>

                <!-- Cycle Progress -->
                <div class="bg-dark-800/50 rounded-xl p-5 border border-gray-700/30">
                    <div class="text-xs text-gray-500 uppercase tracking-wide mb-3">Cycle Progress</div>
                    <div class="flex gap-1.5 mb-3">
                        <template x-for="d in 7" :key="d">
                            <div class="flex-1 h-2 rounded-full transition-all duration-300"
                                 :class="d <= armsRace.day ? 'progress-bar' : 'bg-gray-700'"></div>
                        </template>
                    </div>
                    <div class="text-sm text-gray-400">
                        <span x-text="armsRace.day"></span> of 7 days completed
                    </div>
                </div>

                <!-- Next/Prev -->
                <div class="bg-dark-800/50 rounded-xl p-5 border border-gray-700/30">
                    <div class="space-y-3">
                        <div>
                            <div class="text-xs text-gray-500 uppercase tracking-wide">Next Up</div>
                            <div class="text-base font-medium text-gray-200" x-text="armsRace.next_event"></div>
                        </div>
                        <div class="w-full h-px bg-gray-700"></div>
                        <div>
                            <div class="text-xs text-gray-500 uppercase tracking-wide">Previous</div>
                            <div class="text-sm text-gray-400" x-text="armsRace.previous_event"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Controls Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Quick Actions -->
            <section class="card rounded-2xl p-6 border border-gray-800/50">
                <div class="flex items-center gap-3 mb-5">
                    <div class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center text-purple-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <h2 class="text-lg font-semibold text-purple-400">Quick Actions</h2>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <button @click="togglePause()"
                            class="p-4 rounded-xl border transition-all duration-200 hover:scale-[1.02]"
                            :class="status.paused
                                ? 'bg-green-500/10 border-green-500/30 hover:bg-green-500/20'
                                : 'bg-yellow-500/10 border-yellow-500/30 hover:bg-yellow-500/20'">
                        <div class="text-2xl mb-1" x-text="status.paused ? '>' : '||'"></div>
                        <div class="text-xs text-gray-400" x-text="status.paused ? 'Resume' : 'Pause'"></div>
                    </button>

                    <button @click="returnToBase()"
                            class="p-4 rounded-xl bg-blue-500/10 border border-blue-500/30 hover:bg-blue-500/20 transition-all duration-200 hover:scale-[1.02]">
                        <div class="text-2xl mb-1">H</div>
                        <div class="text-xs text-gray-400">Home</div>
                    </button>

                    <button @click="refreshStatus(); refreshFlows(); refreshArmsRace();"
                            class="p-4 rounded-xl bg-gray-700/30 border border-gray-600/30 hover:bg-gray-600/30 transition-all duration-200 hover:scale-[1.02]">
                        <div class="text-2xl mb-1">R</div>
                        <div class="text-xs text-gray-400">Refresh</div>
                    </button>
                </div>
            </section>

            <!-- Commands -->
            <section class="card rounded-2xl p-6 border border-gray-800/50">
                <div class="flex items-center gap-3 mb-5">
                    <div class="w-8 h-8 rounded-lg bg-cyan-500/20 flex items-center justify-center text-cyan-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </div>
                    <h2 class="text-lg font-semibold text-cyan-400">Commands</h2>
                </div>

                <div class="space-y-4">
                    <!-- Title -->
                    <div class="flex items-center gap-3">
                        <div class="w-24 text-sm text-gray-400">Title</div>
                        <select x-model="selectedTitle"
                                class="flex-1 bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-purple-500">
                            <option value="">Select title...</option>
                            <template x-for="title in titles" :key="title.name">
                                <option :value="title.name" x-text="title.display_name"></option>
                            </template>
                        </select>
                        <button @click="applyTitle()"
                                :disabled="!selectedTitle"
                                class="px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-500 text-sm font-medium transition disabled:opacity-40 disabled:cursor-not-allowed">
                            Apply
                        </button>
                    </div>

                    <!-- Zombie Mode -->
                    <div class="flex items-center gap-3">
                        <div class="w-24 text-sm text-gray-400">Zombie</div>
                        <select x-model="selectedZombieMode"
                                @change="setZombieMode()"
                                class="flex-1 bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-purple-500">
                            <option value="elite">Elite Zombie (20 stamina)</option>
                            <option value="gold">Gold Mine (10 stamina)</option>
                            <option value="food">Food Farm (10 stamina)</option>
                            <option value="iron_mine">Iron Mine (10 stamina)</option>
                        </select>
                        <div class="w-20 text-right">
                            <span x-show="zombieMode.hours_remaining" class="text-xs text-yellow-400"
                                  x-text="zombieMode.hours_remaining ? zombieMode.hours_remaining.toFixed(1) + 'h' : ''"></span>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Config Overrides -->
        <section class="card rounded-2xl p-6 border border-gray-800/50">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-8 h-8 rounded-lg bg-orange-500/20 flex items-center justify-center text-orange-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                    </svg>
                </div>
                <h2 class="text-lg font-semibold text-orange-400">Config Overrides</h2>
                <span class="ml-2 text-sm text-gray-500" x-text="Object.keys(activeOverrides).length + ' active'"></span>
                <button @click="loadConfig()" class="ml-auto px-3 py-1.5 text-xs rounded-lg bg-gray-700/50 hover:bg-gray-600/50 transition">
                    Refresh
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Rally Settings -->
                <div class="bg-dark-800/50 rounded-xl p-5 border border-gray-700/30">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="text-sm font-medium text-blue-400">Rally Settings</span>
                    </div>

                    <div class="space-y-4">
                        <!-- Rally Join Enabled -->
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm">Rally Join</div>
                                <div class="text-xs text-gray-500" x-text="configs.RALLY_JOIN_ENABLED?.overridden ? 'OVERRIDE' : 'Default: OFF'"></div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span x-show="configs.RALLY_JOIN_ENABLED?.overridden" class="text-xs text-orange-400"
                                      x-text="formatOverrideTime(configs.RALLY_JOIN_ENABLED?.expires_in)"></span>
                                <button @click="toggleConfigOverride('RALLY_JOIN_ENABLED')"
                                        class="relative w-12 h-6 rounded-full transition-colors duration-200"
                                        :class="configs.RALLY_JOIN_ENABLED?.value ? 'bg-green-500' : 'bg-gray-600'">
                                    <span class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform duration-200"
                                          :class="configs.RALLY_JOIN_ENABLED?.value ? 'translate-x-6' : ''"></span>
                                </button>
                            </div>
                        </div>

                        <!-- Ignore Daily Limit -->
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm">Ignore Daily Limit</div>
                                <div class="text-xs text-gray-500" x-text="configs.RALLY_IGNORE_DAILY_LIMIT?.overridden ? 'OVERRIDE' : 'Default: OFF'"></div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span x-show="configs.RALLY_IGNORE_DAILY_LIMIT?.overridden" class="text-xs text-orange-400"
                                      x-text="formatOverrideTime(configs.RALLY_IGNORE_DAILY_LIMIT?.expires_in)"></span>
                                <button @click="toggleConfigOverride('RALLY_IGNORE_DAILY_LIMIT')"
                                        class="relative w-12 h-6 rounded-full transition-colors duration-200"
                                        :class="configs.RALLY_IGNORE_DAILY_LIMIT?.value ? 'bg-green-500' : 'bg-gray-600'">
                                    <span class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform duration-200"
                                          :class="configs.RALLY_IGNORE_DAILY_LIMIT?.value ? 'translate-x-6' : ''"></span>
                                </button>
                            </div>
                        </div>

                        <!-- Duration selector for rally overrides -->
                        <div class="flex items-center gap-3 pt-2 border-t border-gray-700/50">
                            <span class="text-xs text-gray-500">Duration:</span>
                            <select x-model="overrideDuration"
                                    class="flex-1 bg-dark-900 border border-gray-700 rounded-lg px-3 py-1.5 text-sm">
                                <option value="15">15 minutes</option>
                                <option value="30">30 minutes</option>
                                <option value="60">1 hour</option>
                                <option value="120">2 hours</option>
                                <option value="240">4 hours</option>
                                <option value="480">8 hours</option>
                                <option value="1440">24 hours</option>
                                <option value="4320">3 days</option>
                                <option value="10080">7 days</option>
                                <option value="">Permanent</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Stamina Settings -->
                <div class="bg-dark-800/50 rounded-xl p-5 border border-gray-700/30">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="text-sm font-medium text-yellow-400">Stamina Settings</span>
                    </div>

                    <div class="space-y-4">
                        <!-- Elite Zombie Threshold -->
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-sm">Elite Threshold</div>
                                <div class="flex items-center gap-2">
                                    <span x-show="configs.ELITE_ZOMBIE_STAMINA_THRESHOLD?.overridden" class="text-xs text-orange-400"
                                          x-text="formatOverrideTime(configs.ELITE_ZOMBIE_STAMINA_THRESHOLD?.expires_in)"></span>
                                    <input type="number" x-model.number="staminaThreshold"
                                           min="0" max="200"
                                           class="w-20 bg-dark-900 border border-gray-700 rounded px-2 py-1 text-sm text-right">
                                </div>
                            </div>
                            <div class="text-xs text-gray-500">Default: 118</div>
                        </div>

                        <!-- Plus Clicks -->
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-sm">Plus Clicks</div>
                                <div class="flex items-center gap-2">
                                    <span x-show="configs.ELITE_ZOMBIE_PLUS_CLICKS?.overridden" class="text-xs text-orange-400"
                                          x-text="formatOverrideTime(configs.ELITE_ZOMBIE_PLUS_CLICKS?.expires_in)"></span>
                                    <input type="number" x-model.number="plusClicks"
                                           min="0" max="15"
                                           class="w-20 bg-dark-900 border border-gray-700 rounded px-2 py-1 text-sm text-right">
                                </div>
                            </div>
                            <div class="text-xs text-gray-500">Default: 5</div>
                        </div>

                        <!-- Apply Stamina Overrides Button -->
                        <button @click="applyStaminaOverrides()"
                                class="w-full py-2 rounded-lg bg-yellow-500/20 border border-yellow-500/30 hover:bg-yellow-500/30 text-yellow-300 text-sm transition">
                            Apply Stamina Overrides
                        </button>
                    </div>
                </div>

                <!-- Arms Race Toggles -->
                <div class="bg-dark-800/50 rounded-xl p-5 border border-gray-700/30">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="text-sm font-medium text-purple-400">Arms Race Events</span>
                    </div>

                    <div class="space-y-4">
                        <!-- Beast Training -->
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm">Beast Training</div>
                                <div class="text-xs text-gray-500" x-text="configs.ARMS_RACE_BEAST_TRAINING_ENABLED?.overridden ? 'OVERRIDE' : 'Default: ON'"></div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span x-show="configs.ARMS_RACE_BEAST_TRAINING_ENABLED?.overridden" class="text-xs text-orange-400"
                                      x-text="formatOverrideTime(configs.ARMS_RACE_BEAST_TRAINING_ENABLED?.expires_in)"></span>
                                <button @click="toggleConfigOverride('ARMS_RACE_BEAST_TRAINING_ENABLED')"
                                        class="relative w-12 h-6 rounded-full transition-colors duration-200"
                                        :class="configs.ARMS_RACE_BEAST_TRAINING_ENABLED?.value ? 'bg-green-500' : 'bg-gray-600'">
                                    <span class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform duration-200"
                                          :class="configs.ARMS_RACE_BEAST_TRAINING_ENABLED?.value ? 'translate-x-6' : ''"></span>
                                </button>
                            </div>
                        </div>

                        <!-- Soldier Training -->
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm">Soldier Training</div>
                                <div class="text-xs text-gray-500" x-text="configs.ARMS_RACE_SOLDIER_TRAINING_ENABLED?.overridden ? 'OVERRIDE' : 'Default: ON'"></div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span x-show="configs.ARMS_RACE_SOLDIER_TRAINING_ENABLED?.overridden" class="text-xs text-orange-400"
                                      x-text="formatOverrideTime(configs.ARMS_RACE_SOLDIER_TRAINING_ENABLED?.expires_in)"></span>
                                <button @click="toggleConfigOverride('ARMS_RACE_SOLDIER_TRAINING_ENABLED')"
                                        class="relative w-12 h-6 rounded-full transition-colors duration-200"
                                        :class="configs.ARMS_RACE_SOLDIER_TRAINING_ENABLED?.value ? 'bg-green-500' : 'bg-gray-600'">
                                    <span class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform duration-200"
                                          :class="configs.ARMS_RACE_SOLDIER_TRAINING_ENABLED?.value ? 'translate-x-6' : ''"></span>
                                </button>
                            </div>
                        </div>

                        <!-- Enhance Hero -->
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm">Enhance Hero</div>
                                <div class="text-xs text-gray-500" x-text="configs.ARMS_RACE_ENHANCE_HERO_ENABLED?.overridden ? 'OVERRIDE' : 'Default: ON'"></div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span x-show="configs.ARMS_RACE_ENHANCE_HERO_ENABLED?.overridden" class="text-xs text-orange-400"
                                      x-text="formatOverrideTime(configs.ARMS_RACE_ENHANCE_HERO_ENABLED?.expires_in)"></span>
                                <button @click="toggleConfigOverride('ARMS_RACE_ENHANCE_HERO_ENABLED')"
                                        class="relative w-12 h-6 rounded-full transition-colors duration-200"
                                        :class="configs.ARMS_RACE_ENHANCE_HERO_ENABLED?.value ? 'bg-green-500' : 'bg-gray-600'">
                                    <span class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform duration-200"
                                          :class="configs.ARMS_RACE_ENHANCE_HERO_ENABLED?.value ? 'translate-x-6' : ''"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Overrides Summary -->
                <div class="bg-dark-800/50 rounded-xl p-5 border border-orange-500/20" x-show="Object.keys(activeOverrides).length > 0">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="text-sm font-medium text-orange-400">Active Overrides</span>
                    </div>

                    <div class="space-y-2">
                        <template x-for="(override, key) in activeOverrides" :key="key">
                            <div class="flex items-center justify-between py-2 border-b border-gray-700/30 last:border-0">
                                <div>
                                    <div class="text-sm" x-text="formatConfigName(key)"></div>
                                    <div class="text-xs text-gray-500">
                                        <span x-text="JSON.stringify(override.value)"></span>
                                        <span class="text-orange-400 ml-2" x-text="formatOverrideTime(override.expires_in)"></span>
                                    </div>
                                </div>
                                <button @click="clearOverride(key)"
                                        class="px-2 py-1 text-xs rounded bg-red-500/20 hover:bg-red-500/30 text-red-400 transition">
                                    Clear
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </section>

        <!-- Flow Grid -->
        <section class="card rounded-2xl p-6 border border-gray-800/50 glow">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                        </svg>
                    </div>
                    <h2 class="text-lg font-semibold text-blue-400">Flows</h2>
                    <span class="text-sm text-gray-500" x-text="flows.length + ' available'"></span>
                </div>

                <div class="flex items-center gap-4 text-xs text-gray-500">
                    <span class="flex items-center gap-1.5">
                        <span class="w-2.5 h-2.5 rounded bg-amber-500/50"></span> Critical
                    </span>
                    <span class="flex items-center gap-1.5">
                        <span class="w-2.5 h-2.5 rounded bg-gray-600"></span> Normal
                    </span>
                    <span class="flex items-center gap-1.5">
                        <span class="w-2.5 h-2.5 rounded bg-blue-500 pulse-slow"></span> Running
                    </span>
                </div>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                <template x-for="flow in flows" :key="flow.name">
                    <button @click="runFlow(flow.name)"
                            :disabled="flow.running"
                            class="flow-btn group relative p-4 rounded-xl text-left border transition-all"
                            :class="{
                                'bg-blue-500/20 border-blue-500/50': flow.running,
                                'bg-amber-500/10 border-amber-500/30 hover:border-amber-500/50': flow.critical && !flow.running,
                                'bg-dark-800/50 border-gray-700/50 hover:border-gray-600': !flow.critical && !flow.running,
                                'cursor-not-allowed': flow.running
                            }">
                        <div class="font-medium text-sm truncate mb-1" x-text="formatFlowName(flow.name)"></div>
                        <div class="text-xs text-gray-500" x-show="flow.last_run && !flow.running" x-text="formatLastRun(flow.last_run)"></div>
                        <div class="text-xs text-blue-400 pulse-slow" x-show="flow.running">Running...</div>

                        <!-- Running indicator -->
                        <div x-show="flow.running" class="absolute top-2 right-2 w-2 h-2 rounded-full bg-blue-400 pulse-slow"></div>
                    </button>
                </template>
            </div>
        </section>
    </main>

    <!-- Toast -->
    <div x-show="toast.show" x-cloak
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 translate-y-4"
         x-transition:enter-end="opacity-100 translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         class="fixed bottom-6 right-6 px-5 py-3 rounded-xl shadow-2xl border"
         :class="{
             'bg-green-500/90 border-green-400/30': toast.type === 'success',
             'bg-red-500/90 border-red-400/30': toast.type === 'error',
             'bg-blue-500/90 border-blue-400/30': toast.type === 'info'
         }">
        <span class="font-medium" x-text="toast.message"></span>
    </div>

    <script>
        function dashboard() {
            return {
                status: { paused: false, active_flows: [], critical_flow: null, stamina: null, idle_seconds: 0, view: null },
                armsRace: { current_event: 'Loading...', previous_event: '', next_event: '', day: 1, time_remaining_seconds: 0 },
                flows: [],
                titles: [],
                selectedTitle: '',
                zombieMode: { mode: 'elite', expires: null, hours_remaining: null },
                selectedZombieMode: 'elite',
                toast: { show: false, message: '', type: 'info' },
                lastUpdate: '--:--',
                pollInterval: null,
                countdownInterval: null,
                // Config overrides
                configs: {},
                activeOverrides: {},
                overrideDuration: '120',  // Default 2 hours
                staminaThreshold: 118,
                plusClicks: 5,
                // Arms Race score check
                armsRaceScore: { current_points: null, chest3_target: null, points_to_chest3: null, last_checked: null, error: null },
                armsRaceScoreLoading: false,

                async init() {
                    await Promise.all([
                        this.refreshStatus(),
                        this.refreshFlows(),
                        this.refreshArmsRace(),
                        this.loadTitles(),
                        this.loadZombieMode(),
                        this.loadConfig()
                    ]);
                    this.pollInterval = setInterval(() => {
                        this.refreshStatus();
                        this.refreshFlows();
                        this.refreshArmsRace();
                    }, 3000);
                    this.countdownInterval = setInterval(() => {
                        if (this.armsRace.time_remaining_seconds > 0) this.armsRace.time_remaining_seconds--;
                    }, 1000);
                },

                async refreshStatus() {
                    try {
                        const res = await fetch('/api/status');
                        this.status = await res.json();
                        this.lastUpdate = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    } catch (e) { console.error('Status fetch failed:', e); }
                },

                async refreshFlows() {
                    try {
                        const res = await fetch('/api/flows');
                        this.flows = await res.json();
                    } catch (e) { console.error('Flows fetch failed:', e); }
                },

                async refreshArmsRace() {
                    try {
                        const res = await fetch('/api/arms-race');
                        this.armsRace = await res.json();
                    } catch (e) { console.error('Arms race fetch failed:', e); }
                },

                async checkArmsRaceScore() {
                    this.armsRaceScoreLoading = true;
                    this.armsRaceScore.error = null;
                    try {
                        const res = await fetch('/api/arms-race/check-score', { method: 'POST' });
                        const data = await res.json();
                        if (data.success) {
                            this.armsRaceScore = {
                                current_points: data.current_points,
                                chest3_target: data.chest3_target,
                                points_to_chest3: data.points_to_chest3,
                                last_checked: new Date().toISOString(),
                                error: null
                            };
                            this.showToast(`Score: ${data.current_points?.toLocaleString() || 0} points`, 'success');
                        } else {
                            this.armsRaceScore.error = data.error || 'Failed to check score';
                            this.showToast(this.armsRaceScore.error, 'error');
                        }
                    } catch (e) {
                        this.armsRaceScore.error = e.message;
                        this.showToast(`Error: ${e.message}`, 'error');
                    } finally {
                        this.armsRaceScoreLoading = false;
                    }
                },

                async runFlow(name) {
                    try {
                        const res = await fetch(`/api/flows/${name}/run`, { method: 'POST' });
                        const data = await res.json();
                        this.showToast(data.success ? `Started ${this.formatFlowName(name)}` : `Failed: ${data.detail}`, data.success ? 'success' : 'error');
                        await this.refreshFlows();
                    } catch (e) { this.showToast(`Error: ${e.message}`, 'error'); }
                },

                async togglePause() {
                    try {
                        await fetch(this.status.paused ? '/api/resume' : '/api/pause', { method: 'POST' });
                        await this.refreshStatus();
                        this.showToast(this.status.paused ? 'Paused' : 'Resumed', 'info');
                    } catch (e) { this.showToast(`Error: ${e.message}`, 'error'); }
                },

                async returnToBase() {
                    try {
                        this.showToast('Returning to base...', 'info');
                        const res = await fetch('/api/return-to-base', { method: 'POST' });
                        const data = await res.json();
                        this.showToast(data.success ? 'Returned to base' : 'Failed', data.success ? 'success' : 'error');
                    } catch (e) { this.showToast(`Error: ${e.message}`, 'error'); }
                },

                async loadTitles() {
                    try {
                        const res = await fetch('/api/titles');
                        const data = await res.json();
                        this.titles = data.titles || [];
                    } catch (e) { console.error('Titles load failed:', e); }
                },

                async applyTitle() {
                    if (!this.selectedTitle) return;
                    try {
                        this.showToast(`Applying ${this.selectedTitle}...`, 'info');
                        const res = await fetch(`/api/titles/${this.selectedTitle}/apply`, { method: 'POST' });
                        const data = await res.json();
                        this.showToast(data.success ? `Applied ${this.selectedTitle}` : `Failed: ${data.detail}`, data.success ? 'success' : 'error');
                    } catch (e) { this.showToast(`Error: ${e.message}`, 'error'); }
                },

                async loadZombieMode() {
                    try {
                        const res = await fetch('/api/zombie-mode');
                        const data = await res.json();
                        this.zombieMode = { mode: data.mode || 'elite', expires: data.expires, hours_remaining: data.hours_remaining };
                        this.selectedZombieMode = this.zombieMode.mode;
                    } catch (e) { console.error('Zombie mode load failed:', e); }
                },

                async setZombieMode() {
                    try {
                        const res = await fetch(`/api/zombie-mode/${this.selectedZombieMode}`, { method: 'POST' });
                        const data = await res.json();
                        if (data.success) {
                            this.showToast(`Zombie: ${this.selectedZombieMode}`, 'success');
                            await this.loadZombieMode();
                        } else {
                            this.showToast(`Failed: ${data.detail}`, 'error');
                        }
                    } catch (e) { this.showToast(`Error: ${e.message}`, 'error'); }
                },

                showToast(message, type = 'info') {
                    this.toast = { show: true, message, type };
                    setTimeout(() => { this.toast.show = false; }, 3000);
                },

                formatFlowName(name) {
                    return name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                },

                formatSeconds(secs) {
                    if (!secs) return '0:00';
                    const m = Math.floor(secs / 60);
                    const s = Math.floor(secs % 60);
                    return `${m}:${s.toString().padStart(2, '0')}`;
                },

                formatCountdown(secs) {
                    if (!secs) return '0:00:00';
                    const h = Math.floor(secs / 3600);
                    const m = Math.floor((secs % 3600) / 60);
                    const s = Math.floor(secs % 60);
                    return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                },

                formatLastRun(isoDate) {
                    if (!isoDate) return '';
                    const diffMins = Math.floor((new Date() - new Date(isoDate)) / 60000);
                    if (diffMins < 1) return 'Just now';
                    if (diffMins < 60) return `${diffMins}m ago`;
                    if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
                    return new Date(isoDate).toLocaleDateString();
                },

                formatTimeAgo(isoDate) {
                    if (!isoDate) return '';
                    const diffMins = Math.floor((new Date() - new Date(isoDate)) / 60000);
                    if (diffMins < 1) return 'just now';
                    if (diffMins < 60) return `${diffMins} minute${diffMins === 1 ? '' : 's'} ago`;
                    const hours = Math.floor(diffMins / 60);
                    const mins = diffMins % 60;
                    if (hours < 24) {
                        if (mins === 0) return `${hours} hour${hours === 1 ? '' : 's'} ago`;
                        return `${hours}h ${mins}m ago`;
                    }
                    return new Date(isoDate).toLocaleString();
                },

                // =============================================
                // Config Override Methods
                // =============================================

                async loadConfig() {
                    try {
                        const res = await fetch('/api/config');
                        const data = await res.json();
                        this.configs = data.configs || {};

                        // Update local values from configs
                        if (this.configs.ELITE_ZOMBIE_STAMINA_THRESHOLD) {
                            this.staminaThreshold = this.configs.ELITE_ZOMBIE_STAMINA_THRESHOLD.value;
                        }
                        if (this.configs.ELITE_ZOMBIE_PLUS_CLICKS) {
                            this.plusClicks = this.configs.ELITE_ZOMBIE_PLUS_CLICKS.value;
                        }

                        // Build active overrides list
                        this.activeOverrides = {};
                        for (const [key, cfg] of Object.entries(this.configs)) {
                            if (cfg.overridden) {
                                this.activeOverrides[key] = cfg;
                            }
                        }
                    } catch (e) {
                        console.error('Config load failed:', e);
                    }
                },

                async toggleConfigOverride(key) {
                    const cfg = this.configs[key];
                    if (!cfg) return;

                    const newValue = !cfg.value;
                    const duration = this.overrideDuration ? parseInt(this.overrideDuration) : null;

                    try {
                        const res = await fetch(`/api/config/${key}/override`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ value: newValue, duration_minutes: duration })
                        });
                        const data = await res.json();
                        if (data.success) {
                            this.showToast(`${this.formatConfigName(key)}: ${newValue ? 'ON' : 'OFF'}`, 'success');
                            await this.loadConfig();
                        } else {
                            this.showToast(`Failed: ${data.error || 'Unknown error'}`, 'error');
                        }
                    } catch (e) {
                        this.showToast(`Error: ${e.message}`, 'error');
                    }
                },

                async applyStaminaOverrides() {
                    const duration = this.overrideDuration ? parseInt(this.overrideDuration) : null;

                    try {
                        // Apply threshold override
                        if (this.staminaThreshold !== 118) {
                            await fetch('/api/config/ELITE_ZOMBIE_STAMINA_THRESHOLD/override', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ value: this.staminaThreshold, duration_minutes: duration })
                            });
                        }

                        // Apply plus clicks override
                        if (this.plusClicks !== 5) {
                            await fetch('/api/config/ELITE_ZOMBIE_PLUS_CLICKS/override', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ value: this.plusClicks, duration_minutes: duration })
                            });
                        }

                        this.showToast('Stamina overrides applied', 'success');
                        await this.loadConfig();
                    } catch (e) {
                        this.showToast(`Error: ${e.message}`, 'error');
                    }
                },

                async clearOverride(key) {
                    try {
                        const res = await fetch(`/api/config/${key}/override`, { method: 'DELETE' });
                        const data = await res.json();
                        if (data.success) {
                            this.showToast(`Cleared ${this.formatConfigName(key)}`, 'info');
                            await this.loadConfig();
                        } else {
                            this.showToast(`Failed: ${data.error || 'Unknown error'}`, 'error');
                        }
                    } catch (e) {
                        this.showToast(`Error: ${e.message}`, 'error');
                    }
                },

                formatOverrideTime(seconds) {
                    if (!seconds) return 'Permanent';
                    if (seconds < 60) return `${seconds}s`;
                    if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
                    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ${Math.floor((seconds % 3600) / 60)}m`;
                    return `${Math.floor(seconds / 86400)}d`;
                },

                formatConfigName(key) {
                    return key.replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
                },
            };
        }
    </script>
</body>
</html>
