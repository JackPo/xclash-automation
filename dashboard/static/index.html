<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xclash Mastermind Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .flow-btn { transition: all 0.15s ease; }
        .flow-btn:hover { transform: scale(1.02); }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen" x-data="dashboard()" x-init="init()">
    <!-- Status Bar -->
    <header class="bg-gray-800 border-b border-gray-700 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-6">
                    <h1 class="text-xl font-bold text-blue-400">‚öîÔ∏è xclash Mastermind</h1>

                    <!-- Daemon Status -->
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-400">Daemon:</span>
                        <span x-show="!status.paused" class="px-2 py-0.5 text-xs rounded bg-green-600">Running</span>
                        <span x-show="status.paused" class="px-2 py-0.5 text-xs rounded bg-yellow-600">Paused</span>
                    </div>

                    <!-- View State -->
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-400">View:</span>
                        <span class="px-2 py-0.5 text-xs rounded"
                              :class="status.view === 'TOWN' ? 'bg-purple-600' : status.view === 'WORLD' ? 'bg-blue-600' : 'bg-gray-600'"
                              x-text="status.view || 'Unknown'"></span>
                    </div>

                    <!-- Stamina -->
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-400">‚ö° Stamina:</span>
                        <span class="font-mono" x-text="status.stamina ?? '--'"></span>
                    </div>

                    <!-- Idle Time -->
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-400">üí§ Idle:</span>
                        <span class="font-mono" x-text="formatSeconds(status.idle_seconds)"></span>
                    </div>
                </div>

                <!-- Active Flow -->
                <div x-show="status.active_flows.length > 0" class="flex items-center space-x-2">
                    <span class="text-sm text-gray-400">Running:</span>
                    <span class="px-2 py-0.5 text-xs rounded bg-blue-600 pulse" x-text="status.active_flows.join(', ')"></span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
        <!-- Arms Race Panel -->
        <section class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <h2 class="text-lg font-semibold mb-4 text-yellow-400">üèÜ Arms Race</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Current Event -->
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="text-sm text-gray-400 mb-1">Current Event</div>
                    <div class="text-xl font-bold text-green-400" x-text="armsRace.current_event"></div>
                    <div class="text-sm text-gray-300 mt-2">
                        <span class="text-gray-400">Time left:</span>
                        <span class="font-mono text-yellow-300" x-text="formatCountdown(armsRace.time_remaining_seconds)"></span>
                    </div>
                </div>

                <!-- Day in Cycle -->
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="text-sm text-gray-400 mb-1">Cycle Position</div>
                    <div class="text-xl font-bold">Day <span x-text="armsRace.day" class="text-blue-400"></span> of 7</div>
                    <div class="mt-2 flex space-x-1">
                        <template x-for="d in 7" :key="d">
                            <div class="w-8 h-2 rounded"
                                 :class="d <= armsRace.day ? 'bg-blue-500' : 'bg-gray-600'"></div>
                        </template>
                    </div>
                </div>

                <!-- Next Event -->
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="text-sm text-gray-400 mb-1">Next Event</div>
                    <div class="text-xl font-bold text-gray-300" x-text="armsRace.next_event"></div>
                    <div class="text-sm text-gray-400 mt-2">Previous: <span x-text="armsRace.previous_event"></span></div>
                </div>
            </div>
        </section>

        <!-- Quick Actions -->
        <section class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <h2 class="text-lg font-semibold mb-4 text-purple-400">‚ö° Quick Actions</h2>

            <div class="flex flex-wrap gap-3">
                <button @click="togglePause()"
                        class="px-4 py-2 rounded font-medium transition"
                        :class="status.paused ? 'bg-green-600 hover:bg-green-500' : 'bg-yellow-600 hover:bg-yellow-500'">
                    <span x-text="status.paused ? '‚ñ∂Ô∏è Resume Daemon' : '‚è∏Ô∏è Pause Daemon'"></span>
                </button>

                <button @click="returnToBase()"
                        class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-500 font-medium transition">
                    üè† Return to Base
                </button>

                <button @click="refreshStatus()"
                        class="px-4 py-2 rounded bg-gray-600 hover:bg-gray-500 font-medium transition">
                    üîÑ Refresh
                </button>
            </div>
        </section>

        <!-- Flow Control Grid -->
        <section class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <h2 class="text-lg font-semibold mb-4 text-blue-400">üéÆ Flow Control</h2>

            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                <template x-for="flow in flows" :key="flow.name">
                    <button @click="runFlow(flow.name)"
                            :disabled="flow.running"
                            class="flow-btn p-3 rounded-lg text-left border transition"
                            :class="{
                                'bg-blue-600 border-blue-500 pulse': flow.running,
                                'bg-yellow-600/20 border-yellow-600 hover:bg-yellow-600/30': flow.critical && !flow.running,
                                'bg-gray-700 border-gray-600 hover:bg-gray-600': !flow.critical && !flow.running,
                                'opacity-50 cursor-not-allowed': flow.running
                            }">
                        <div class="font-medium text-sm truncate" x-text="formatFlowName(flow.name)"></div>
                        <div class="text-xs text-gray-400 mt-1" x-show="flow.last_run">
                            <span x-text="formatLastRun(flow.last_run)"></span>
                        </div>
                        <div class="text-xs text-blue-300 mt-1" x-show="flow.running">Running...</div>
                    </button>
                </template>
            </div>

            <div class="mt-4 flex items-center space-x-4 text-sm text-gray-400">
                <span class="flex items-center"><span class="w-3 h-3 rounded bg-yellow-600/50 mr-1"></span> Critical</span>
                <span class="flex items-center"><span class="w-3 h-3 rounded bg-gray-600 mr-1"></span> Normal</span>
                <span class="flex items-center"><span class="w-3 h-3 rounded bg-blue-600 mr-1"></span> Running</span>
            </div>
        </section>

        <!-- Toast Notifications -->
        <div x-show="toast.show" x-cloak
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-y-2"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 transform translate-y-0"
             x-transition:leave-end="opacity-0 transform translate-y-2"
             class="fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg"
             :class="toast.type === 'success' ? 'bg-green-600' : toast.type === 'error' ? 'bg-red-600' : 'bg-blue-600'">
            <span x-text="toast.message"></span>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 border-t border-gray-700 mt-8 py-4">
        <div class="max-w-7xl mx-auto px-4 text-center text-sm text-gray-500">
            Last updated: <span x-text="lastUpdate"></span>
            <span class="mx-2">|</span>
            Auto-refresh: 3s
        </div>
    </footer>

    <script>
        function dashboard() {
            return {
                status: {
                    paused: false,
                    active_flows: [],
                    critical_flow: null,
                    stamina: null,
                    idle_seconds: 0,
                    view: null,
                },
                armsRace: {
                    current_event: 'Loading...',
                    previous_event: '',
                    next_event: '',
                    day: 1,
                    time_remaining_seconds: 0,
                },
                flows: [],
                toast: { show: false, message: '', type: 'info' },
                lastUpdate: 'Never',
                pollInterval: null,
                countdownInterval: null,

                async init() {
                    await this.refreshStatus();
                    await this.refreshFlows();
                    await this.refreshArmsRace();

                    // Start polling
                    this.pollInterval = setInterval(() => {
                        this.refreshStatus();
                        this.refreshFlows();
                        this.refreshArmsRace();
                    }, 3000);

                    // Countdown timer (update every second)
                    this.countdownInterval = setInterval(() => {
                        if (this.armsRace.time_remaining_seconds > 0) {
                            this.armsRace.time_remaining_seconds--;
                        }
                    }, 1000);
                },

                async refreshStatus() {
                    try {
                        const res = await fetch('/api/status');
                        this.status = await res.json();
                        this.lastUpdate = new Date().toLocaleTimeString();
                    } catch (e) {
                        console.error('Failed to fetch status:', e);
                    }
                },

                async refreshFlows() {
                    try {
                        const res = await fetch('/api/flows');
                        this.flows = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch flows:', e);
                    }
                },

                async refreshArmsRace() {
                    try {
                        const res = await fetch('/api/arms-race');
                        this.armsRace = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch arms race:', e);
                    }
                },

                async runFlow(flowName) {
                    try {
                        const res = await fetch(`/api/flows/${flowName}/run`, { method: 'POST' });
                        const data = await res.json();
                        if (data.success) {
                            this.showToast(`Started: ${this.formatFlowName(flowName)}`, 'success');
                        } else {
                            this.showToast(`Failed: ${data.detail || 'Unknown error'}`, 'error');
                        }
                        await this.refreshFlows();
                    } catch (e) {
                        this.showToast(`Error: ${e.message}`, 'error');
                    }
                },

                async togglePause() {
                    const endpoint = this.status.paused ? '/api/resume' : '/api/pause';
                    try {
                        await fetch(endpoint, { method: 'POST' });
                        await this.refreshStatus();
                        this.showToast(this.status.paused ? 'Daemon paused' : 'Daemon resumed', 'info');
                    } catch (e) {
                        this.showToast(`Error: ${e.message}`, 'error');
                    }
                },

                async returnToBase() {
                    try {
                        this.showToast('Returning to base...', 'info');
                        const res = await fetch('/api/return-to-base', { method: 'POST' });
                        const data = await res.json();
                        this.showToast(data.success ? 'Returned to base' : 'Failed to return', data.success ? 'success' : 'error');
                    } catch (e) {
                        this.showToast(`Error: ${e.message}`, 'error');
                    }
                },

                showToast(message, type = 'info') {
                    this.toast = { show: true, message, type };
                    setTimeout(() => { this.toast.show = false; }, 3000);
                },

                formatFlowName(name) {
                    return name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                },

                formatSeconds(secs) {
                    if (!secs) return '0:00';
                    const m = Math.floor(secs / 60);
                    const s = Math.floor(secs % 60);
                    return `${m}:${s.toString().padStart(2, '0')}`;
                },

                formatCountdown(secs) {
                    if (!secs) return '0:00:00';
                    const h = Math.floor(secs / 3600);
                    const m = Math.floor((secs % 3600) / 60);
                    const s = Math.floor(secs % 60);
                    return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                },

                formatLastRun(isoDate) {
                    if (!isoDate) return '';
                    const d = new Date(isoDate);
                    const now = new Date();
                    const diffMs = now - d;
                    const diffMins = Math.floor(diffMs / 60000);

                    if (diffMins < 1) return 'Just now';
                    if (diffMins < 60) return `${diffMins}m ago`;
                    if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
                    return d.toLocaleDateString();
                },
            };
        }
    </script>
</body>
</html>
